<style>
  body {
    font-family: 'SF Pro Display', 'SF Compact Display', sans-serif;
    background: #222;
    margin: 0;
    padding: 20px 5px;
    font-size: 16px;
    color: #fff;
  }
  .clearfix::after {
    content: "";
    display: block;
    clear: both;
  }
  .hidden {
    display: none;
  }
  .loading {
    background-image: url('https://raw.githubusercontent.com/kudakurage/figma-symbols-browser/master/assets/loading.gif');
    background-position: center center;
    background-repeat: no-repeat;
    min-height: 600px;
  }
  textarea {
      height:1px;
      border:0;
      margin:0;
      padding:0;
      opacity:0;
  }
  #navbar,
  #settings-navbar {
    position: fixed;
    background: #333;
    top: 0;
    left: 0;
    width: 100%;
    height: 44px;
    line-height: 30px;
    padding: 7px 0 7px 7px;
    box-sizing: border-box;
    border-bottom: 1px solid #555;
    z-index: 10;
  }
  #symbol-type {
    float: left;
    font-weight: bold;
    margin-right: 7px;
  }
  #symbol-type div {
    float: left;
    min-width: 20px;
    height: 30px;
    line-height: 30px;
    padding: 0 5px;
    font-size: 20px;
    background: #555;
    text-align: center;
    cursor: pointer;
  }
  #search {
    float: left;
    font-size: 15px;
    width: 160px;
    height: 30px;
    line-height: 30px;
    margin-right: 4px;
    padding: 0 5px;
    border: 0;
    border-radius: 4px;
    background: #555;
    color: #fff;
  }
  #display-type {
    float: left;
    margin-right: 7px;
  }
  #display-type div {
    float: left;
    height: 30px;
    line-height: 30px;
    padding: 0 5px;
    background: #555;
    text-align: center;
    cursor: pointer;
  }
  #symbol-type div:first-child,
  #display-type div:first-child {
    border-radius: 4px 0 0 4px;
  }
  #symbol-type div:last-child,
  #display-type div:last-child {
    border-radius: 0 4px 4px 0;
  }
  #symbol-type .active,
  #display-type .active {
    background: #aaa;
    color: #222;
  }
  #symbols-table {
    padding: 35px 0 0;
  }
  .symbol-item {
    height: 90px;
    width: 90px;
    margin-bottom: 10px;
    padding-bottom: 5px;
    text-align: center;
    float: left;
    border-radius: 5px;
    cursor: pointer;
  }
  .symbol-item:hover {
    background: #444;
  }
  .symbol-item:active {
    background: #007AFF;
    border-color: #007AFF;
  }
  .symbol-item-glyph {
    height: 60px;
    width: 90px;
    font-size: 32px;
    line-height: 60px;
    pointer-events: none;
    vertical-align: middle;
  }
  .symbol-item-name {
    height: 30px;
    width: 80px;
    padding: 0 5px;
    font-size: 13px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    word-wrap: break-word;
    overflow-wrap : break-word;
    pointer-events: none;
  }
  .material-icons .symbol-item-glyph {
    font-family: 'Material Icons';
  }
  #symbols-table.symbol-type-material .sf-symbols,
  #symbols-table.symbol-type-sfsymbols .material-icons {
    display: none;
  }
  .material-icons-hidden #symbols-table .material-icons {
    display: none;
  }
  .display-type-symbols .symbol-item {
    height: 50px;
    width: 60px;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .display-type-symbols .symbol-item-glyph {
    height: 50px;
    width: 60px;
    font-size: 24px;
    line-height: 50px;
  }
  .display-type-symbols .symbol-item-name {
    display: none;
  }
  .display-type-list .symbol-item {
    height: 30px;
    line-height: 30px;
    width: 100%;
    margin: 0 -5px;
    padding: 0 5px;
    border-radius: 0;
    text-align: left;
    float: none;
    cursor: pointer;
  }
  .display-type-list .symbol-item:nth-child(2n-1) {
    background: #333;
  }
  .display-type-list .symbol-item:hover {
    background: #444;
  }
  .display-type-list .symbol-item:active {
    background: #007AFF;
  }
  .display-type-list .symbol-item-glyph {
    float: left;
    height: 30px;
    width: 40px;
    margin: 0;
    text-align: center;
    font-size: 18px;
    line-height: 30px;
    border: 0;
  }
  .display-type-list .symbol-item-name {
    height: 30px;
    width: auto;
    padding: 0 10px;
    font-size: 15px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  #toast-message {
    background: rgba(0,122,255,0.9);
    position: fixed;
    top: 20px;
    left: 0;
    width: 100%;
    height: 30px;
    line-height: 30px;
    box-sizing: border-box;
    margin-top: 0;
    text-align: center;
    font-size: 14px;
    font-weight: bold;
    z-index: 0;
    opacity: 0;
    transition: 0.3s;
  }
  #toast-message.show {
    margin-top: 24px;
    opacity: 1;
  }
  #toast-message.symbol-type-material span {
    font-family: 'Material Icons';
    vertical-align: bottom;
  }
  .install-font {
    padding: 30px 10px;
  }
  .install-font .title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 0;
  }
  .install-font .subtle {
    font-size: 13px;
    color: #666;
    margin-bottom: 30px;
  }
  .install-font .button {
    display: block;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    background: #007AFF;
    border-radius: 5px;
    line-height: 50px;
    text-decoration: none;
  }
  .install-font .button:hover {
    opacity: 0.8;
  }
  #settings-navbar {
    padding-left: 15px;
  }
  #settings-button,
  #settings-close {
    float: left;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    cursor: pointer;
    border-radius: 5px;
  }
  #settings-button:hover,
  #settings-close:hover {
    background: #444;
  }
  #settings-close {
    float: right;
    margin-right: 4px;
  }
  #settings-body {
    padding: 40px 15px;
  }
</style>
<div id="main-view">
  <div id="navbar">
    <div id="symbol-type" class="clearfix">
      <div id="symbol-type-sfsymbols" class="symbol-type-item active"></div>
      <div id="symbol-type-material" class="symbol-type-item">G</div>
    </div>
    <div id="display-type" class="clearfix">
      <div id="display-type-symbols" class="display-type-item">􀇹</div>
      <div id="display-type-tile" class="display-type-item active">􀛧</div>
      <div id="display-type-list" class="display-type-item">􀋱</div>
    </div>
    <input type="text" id="search" placeholder="􀊫 search" />
    <div id="settings-button">􀍠</div>
  </div>
  <div id="toast-message">Toast Message</div>
  <div id="symbols-table" class="clearfix loading"></div>
  <div id="install-font" class="install-font hidden">
    <p class="title">Please install San Francisco fonts to use this plugin.</p>
    <p class="subtle">(Run this plugin again after installing the fonts.)</p>
    <a href="https://developer.apple.com/fonts/" target="_blank" class="button">Download Page</a>
  </div>
  <div id="install-material-icons" class="install-font hidden">
      <p class="title">Please install 'MaterialIcons-Regular.ttf' to display Material Icons.</p>
      <p class="subtle">(Run this plugin again after installing the font.)</p>
      <a href="https://github.com/google/material-design-icons" target="_blank" class="button">Download Page</a>
    </div>
  </div>
<div id="settings-view" class="hidden">
  <div id="settings-navbar">
    <div id="settings-close">􀅾</div>
    Settings
  </div>
  <div id="settings-body">
    <div>
      When click symbols:
      <select id="settings-click-action" onchange="setClickActionSetting(this);">
        <option value="copy">Copy to Clipboard</option>
        <option value="paste">Copy & Paste to selected text</option>
      </select>
    </div>
  </div>
</div>
<textarea></textarea>
<script>
const sfCsvFileName = 'https://raw.githubusercontent.com/kudakurage/figma-symbols-browser/master/assets/SFSymbols.csv'
const miCsvFileName = 'https://raw.githubusercontent.com/kudakurage/figma-symbols-browser/master/assets/Material_Icons.csv'
const mainView = document.getElementById('main-view')
const settingsView = document.getElementById('settings-view')
const symbolsTable = document.getElementById('symbols-table')
const navbar = document.getElementById('navbar')
const installFont = document.getElementById('install-font')
const searchField = document.getElementById('search')
const toastMessage = document.getElementById('toast-message')
const displayTypeItem = document.getElementsByClassName('display-type-item')
const displayTypeClassList = getDisplayTypeClassList()
const symbolTypeItem = document.getElementsByClassName('symbol-type-item')
const symbolTypeClassList = getSymbolTypeClassList()
var canUsePlugin = false
var toastID = searchKeyword = ''
var masterDataSF = masterData = masterDataMI = []
var settingsData = {}
var installCheckMaterialFont = false

symbolsTable.classList.add('hidden')
navbar.classList.add('hidden')

window.onload = function () {
  let detective = new Detector();
  // check installing fonts: 'SF Pro Display', 'SF Compact Display'
  if (detective.detect('SF Pro Display') == true || detective.detect('SF Compact Display') == true) {
    // console.log('installed!')
    init()
    canUsePlugin = true
  } else {
    // console.log('not install!')
    installFont.classList.remove('hidden')
  }
};


function init(){
  symbolsTable.classList.remove('hidden')
  navbar.classList.remove('hidden')
  for(let i = 0; i < displayTypeItem.length; i++) {
    displayTypeItem[i].addEventListener('click', function(e){
      chnageDisplayType(e.target.getAttribute('id'))
      updateSettings()
    }, false)
  }
  for(let i = 0; i < symbolTypeItem.length; i++) {
    symbolTypeItem[i].addEventListener('click', function(e){
      chnageSymbolType(e.target.getAttribute('id'))
      updateSettings()
    }, false)
  }
  document.getElementById('settings-button').addEventListener('click', function(e){
    mainView.classList.add('hidden')
    settingsView.classList.remove('hidden')
  }, false)
  document.getElementById('settings-close').addEventListener('click', function(e){
    mainView.classList.remove('hidden')
    settingsView.classList.add('hidden')
  }, false)

  getCSV();
}

// response to message from code.ts
onmessage = event => {
  if(canUsePlugin && event.data.pluginMessage.settings){
    settingsData = event.data.pluginMessage.data
    settingsInit()
  }
}

// change display type of symbols list
function chnageDisplayType(targetId){
  for(let j = 0; j < displayTypeItem.length; j++) {
    displayTypeItem[j].classList.remove('active')
  }
  for(let i = 0; i < displayTypeItem.length; i++) {
    symbolsTable.classList.remove(displayTypeItem[i].getAttribute('id'))
  }
  document.getElementById(targetId).classList.add('active')
  symbolsTable.classList.add(targetId)
  settingsData.displayType = targetId
}

// change symbol type
function chnageSymbolType(targetId){
  toastMessage.classList.remove('show')
  for(let j = 0; j < symbolTypeItem.length; j++) {
    symbolTypeItem[j].classList.remove('active')
  }
  for(let i = 0; i < symbolTypeItem.length; i++) {
    symbolsTable.classList.remove(symbolTypeItem[i].getAttribute('id'))
    toastMessage.classList.remove(symbolTypeItem[i].getAttribute('id'))
  }
  document.getElementById(targetId).classList.add('active')
  settingsData.symbolType = targetId
  if(targetId == 'symbol-type-material' && installCheckMaterialFont == false){
    mainView.classList.add('material-icons-hidden')
    let detective = new Detector();
    // check installing fonts: 'Material Icons'
    if (detective.detect('Material Icons') == true) {
      // console.log('installed!')
      installCheckMaterialFont = true
      mainView.classList.remove('material-icons-hidden')
      document.getElementById('install-material-icons').classList.add('hidden')
    } else {
      // console.log('not install!')
      document.getElementById('install-material-icons').classList.remove('hidden')
    }
  }else{
    document.getElementById('install-material-icons').classList.add('hidden')
  }
  symbolsTable.classList.add(targetId)
  toastMessage.classList.add(targetId)
}

// set symbol-click-action settings
function setClickActionSetting(object){
  settingsData.clickAction = object.options[object.selectedIndex].value
  updateSettings()
}

// send message update settings to code.ts
function updateSettings(){
  parent.postMessage({ pluginMessage: { updatedSettingsData: settingsData } }, '*');
}

// initialize settings
function settingsInit(){
  chnageDisplayType(settingsData.displayType)
  chnageSymbolType(settingsData.symbolType)
  let settingClickAction = document.getElementById('settings-click-action')
  for(i=0; settingClickAction.options.length > i; i++){
    if(settingClickAction.options[i].value == settingsData.clickAction){
      settingClickAction.options[i].selected = true;
      break;
    }
  }
}

// get display type list
function getDisplayTypeClassList(){
  let classList = ''
  for(let i = 0; i < displayTypeItem.length; i++) {
    classList += displayTypeItem[i].getAttribute('id')+','
  }
  return classList
}

// get symbol type list
function getSymbolTypeClassList(){
  let classList = ''
  for(let i = 0; i < symbolTypeItem.length; i++) {
    classList += symbolTypeItem[i].getAttribute('id')+','
  }
  return classList
}

// set up search event
function setupSearch(){
  searchField.addEventListener('keyup', function(){
    if(searchKeyword == searchField.value){
      return false
    }else{
      searchKeyword = searchField.value
    }
    let wordArray = searchKeyword.split(/\s/)
    let filteredList = masterData
    for(let i = 0; i < wordArray.length; i++){
      filteredList = filteringList(filteredList, wordArray[i])
    }
    createGlyphList(filteredList)
  })
}

// filter symbols list with search word
function filteringList(list, filterWord){
  let regex = new RegExp(filterWord)
  let filteredList = list.filter(function(value){
    return regex.test(value.search_keyword);
  })
  return filteredList
}

// copy glyph to clipboard
function copyGlyph(event){
  let glyph = event.target.getAttribute('data-glyph')
  let symbolType = event.target.getAttribute('data-symbol-type')
  let textarea = document.getElementsByTagName("textarea")[0]
  textarea.value = glyph
  textarea.select()
  document.execCommand("copy")
  window.clearTimeout(toastID)
  let message = settingsData.clickAction == 'copy' ? 'Copied symbols' : 'Copied & Pasted symbols'
  toastMessage.innerHTML = message+': <span>'+glyph+'</span>'
  toastMessage.classList.add('show')
  toastID = window.setTimeout(function(){toastMessage.classList.remove('show')}, 2000)
  parent.postMessage({ pluginMessage: { copied: true, copiedGlyph: glyph, symbolType: symbolType } }, '*');
}

// create dom of glyph list
function createGlyphList(data){
  symbolsTable.innerHTML = ''
  data.forEach(val => {
    let divWrapper = document.createElement('div')
    let divGlyph = document.createElement('div')
    let divName = document.createElement('div')
    divWrapper.classList.add('symbol-item', val.symbol_type)
    divGlyph.classList.add('symbol-item-glyph')
    divName.classList.add('symbol-item-Name')
    divGlyph.textContent = val.character
    divName.textContent = val.short_name
    divWrapper.appendChild(divGlyph)
    divWrapper.appendChild(divName)
    divWrapper.setAttribute('data-glyph', val.character)
    divWrapper.setAttribute('data-symbol-type', val.symbol_type)
    divWrapper.setAttribute('data-keyword', val.search_keyword)
    divWrapper.addEventListener('click', function(e){copyGlyph(e)}, false)
    symbolsTable.appendChild(divWrapper)
  })
}

// download csv file
function getCSV(){
  let promise_sf = new Promise((resolve, reject) => {
    let reqSF = new XMLHttpRequest()
    reqSF.open("get", sfCsvFileName, true)
    reqSF.send(null)

    reqSF.onload = function(){
      masterDataSF = csv2json(reqSF.responseText, 'SF')
      resolve(true)
    }
  })

  promise_sf.then((response) => {
      let promise_mi = new Promise((resolve, reject) => {
      let reqMI = new XMLHttpRequest()
      reqMI.open("get", miCsvFileName, true)
      reqMI.send(null)

      reqMI.onload = function(){
        masterDataMI = csv2json(reqMI.responseText, 'MI')
        resolve(true)
      }
    }).then((response) => {
      masterData = masterDataSF.concat(masterDataMI)
      symbolsTable.classList.remove('loading')
      createGlyphList(masterData)
      setupSearch()
    })
  })
}

// convert csv to json
function csv2json(csv, type){
  var jsonArray = []
  var csvArray = csv.split('\n')     
  var items = csvArray[0].split(',')
 
  for (var i = 1; i < csvArray.length - 1; i++) {
    let a_line = new Object()
    let master_line = new Object()
    let csvArrayD = csvArray[i].split(/\,(?=(?:[^"]*"[^"]*")*[^"]*$)/)

    for (var j = 0; j < items.length; j++) {
      a_line[items[j]] = csvArrayD[j]
    }

    if(type == "SF" && a_line.ready_for_api == "FALSE"){
      continue;
    }
    if(type == "SF" && a_line.blacklist_apple_only == "TRUE"){
      continue;
    }

    if(type == "SF"){
      master_line.short_name = a_line.short_name.replace(/[\.\_]/g, ' ')
      master_line.search_keyword = a_line.short_name+';'+a_line.apple_action+';'+a_line.apple_entity+';'+a_line.semantic_name_1+';'+a_line.semantic_name_2+';'+a_line.semantic_name_3
      master_line.symbol_type = "sf-symbols"
      master_line.character = a_line.character_auto ? a_line.character_auto : a_line.character
    }else{
      master_line.short_name = a_line.short_name.replace(/[\.\_]/g, ' ')
      master_line.search_keyword = a_line.short_name
      master_line.symbol_type = "material-icons"
      master_line.character = a_line.character
    }
    jsonArray.push(master_line)
  }
  return jsonArray
}

/**
 * JavaScript code to detect available availability of a
 * particular font in a browser using JavaScript and CSS.
 *
 * Author : Lalit Patel
 * Website: http://www.lalit.org/lab/javascript-css-font-detect/
 * License: Apache Software License 2.0
 *          http://www.apache.org/licenses/LICENSE-2.0
 */

/**
 * Usage: d = new Detector();
 *        d.detect('font name');
 */
 var Detector = function() {
    // a font will be compared against all the three default fonts.
    // and if it doesn't match all 3 then that font is not available.
    var baseFonts = ['monospace', 'sans-serif', 'serif'];

    //we use m or w because these two characters take up the maximum width.
    // And we use a LLi so that the same matching fonts can get separated
    var testString = "mmmmmmmmmmlli";

    //we test using 72px font size, we may use any size. I guess larger the better.
    var testSize = '72px';

    var h = document.getElementsByTagName("body")[0];

    // create a SPAN in the document to get the width of the text we use to test
    var s = document.createElement("span");
    s.style.fontSize = testSize;
    s.innerHTML = testString;
    var defaultWidth = {};
    var defaultHeight = {};
    for (var index in baseFonts) {
        //get the default width for the three base fonts
        s.style.fontFamily = baseFonts[index];
        h.appendChild(s);
        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font
        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font
        h.removeChild(s);
    }

    function detect(font) {
        var detected = false;
        for (var index in baseFonts) {
            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.
            h.appendChild(s);
            var matched = (s.offsetWidth != defaultWidth[baseFonts[index]] || s.offsetHeight != defaultHeight[baseFonts[index]]);
            h.removeChild(s);
            detected = detected || matched;
        }
        return detected;
    }

    this.detect = detect;
};
</script>
